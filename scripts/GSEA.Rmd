---
title: "2.1_GSEA"
author: "Ronnie Li"
date: "`r Sys.Date()`"
output: html_document
---

### Gene Set Enrichment ANalysis (GSEA)

This script runs GSEA on the age-associated genes in the GTEx 
Consortium v10 dataset.

```{r setup, include=FALSE}
here::i_am("scripts/GSEA.Rmd")
knitr::opts_chunk$set(echo = TRUE)

suppressMessages(library(tidyverse))
suppressMessages(library(fgsea))
suppressMessages(library(msigdbr))
suppressMessages(library(patchwork))

# ggplot2 theme for manuscript
theme_ms <- function(base_size = 14, base_family = "") {
  ggplot2::theme_classic(base_size = base_size, base_family = base_family) +
    ggplot2::theme(
      panel.border = ggplot2::element_rect(colour = "black", fill = NA, linewidth = 1),
      strip.background = ggplot2::element_rect(linetype = "blank"),
      plot.title = ggplot2::element_text(size = ggplot2::rel(1)),
      axis.text = ggplot2::element_text(size = ggplot2::rel(0.75)),
      panel.grid.minor = ggplot2::element_line(colour = "grey90", linewidth = 0.5),
      panel.grid.major = ggplot2::element_line(colour = "grey90", linewidth = 0.5),
      complete = FALSE
    )
}

# directories
result_dir<- file.path(here::here("data/p_value"))
plot_dir<- file.path(here::here("figures"))
out_dir<- file.path(here::here("data/gsea"))   # 你想存表的目录
tissue_file <- file.path(here::here("data/tissue_names.txt"))
tissues <- readLines(tissue_file)
padj_thresh      <- 1
direction_choice <- "both"
top_n            <- 7
out_height       <- if (direction_choice == "both") 8 else 4

if (!dir.exists(plot_dir))   dir.create(plot_dir, recursive = TRUE)
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)


# get MSigDB genes
geneset <- msigdbr(db_species = "HS", species = "human", 
                   collection = "C2" , subcollection = "CP:WIKIPATHWAYS")
pathway_map <- geneset %>%
  dplyr::distinct(gs_description, gs_name) %>%
  dplyr::rename(pathway_desc = gs_description, pathway_id = gs_name)

gene_list <- split(geneset$gene_symbol, f = geneset$gs_description)

```

### Main GSEA function
Define GSEA function to use `fgsea()` on predefined gene set

```{r}

doGSEA <- function(pval_table, gene_list, tissue_name = "",
                   direction = c("up","down","both"),
                   restrict_ranking = FALSE,
                   top_n = 7) {

  direction <- match.arg(direction)

  df <- pval_table %>%
    dplyr::select(Gene, p_value_age, age_coef) %>%
    dplyr::mutate(
      p_value_age = as.numeric(p_value_age),
      age_coef    = as.numeric(age_coef),
      rank        = sign(age_coef) * -log10(p_value_age)
    ) %>%
    dplyr::filter(is.finite(rank), is.finite(p_value_age), !is.na(Gene))

  # helper to enforce the 100–1000 rule for a given direction
  .prep_and_run <- function(df, which_dir = c("up","down")) {
    which_dir <- match.arg(which_dir)
    sub <- if (which_dir == "up") dplyr::filter(df, age_coef > 0) else dplyr::filter(df, age_coef < 0)

    # sort by significance (smallest p first); cap to top 1000 if needed
    sub <- dplyr::arrange(sub, p_value_age)
    n <- nrow(sub)
    if (n < 100) return(NULL)
    if (n > 1000) sub <- dplyr::slice_head(sub, n = 1000)

    # build stats for fgsea using your original rank metric
    Z <- stats::setNames(sub$rank, sub$Gene)

    set.seed(1234)
    fgseaMultilevel(
      pathways = gene_list,
      stats = Z,
      maxSize = 300,
      nPermSimple = 10000,
      nproc = 1
    ) %>%
      dplyr::mutate(Direction = dplyr::case_when(
        NES > 0 ~ "Upregulated",
        NES < 0 ~ "Downregulated",
        TRUE    ~ NA_character_
      )) %>%
      dplyr::filter(!is.na(Direction), is.finite(padj)) %>%
      dplyr::mutate(Direction = factor(Direction, levels = c("Upregulated","Downregulated")))
  }

  # run per requested direction(s)
  if (direction == "both") {
    gsea_up   <- .prep_and_run(df, "up")
    gsea_down <- .prep_and_run(df, "down")
    gsea_res  <- dplyr::bind_rows(gsea_up, gsea_down)
  } else {
    gsea_res <- .prep_and_run(df, direction)
  }
  # if nothing qualified, return empty result/plot
  if (is.null(gsea_res) || nrow(gsea_res) == 0) {
    return(list(result = tibble::tibble(), plot = ggplot() + theme_void()))
  }

  # optional view filter (kept from your code)
  if (direction == "up")   gsea_res <- dplyr::filter(gsea_res, NES > 0)
  if (direction == "down") gsea_res <- dplyr::filter(gsea_res, NES < 0)

  gsea_res <- dplyr::arrange(gsea_res, padj)

  to_plot <- gsea_res %>%
    dplyr::mutate(
      pathway = stringr::str_wrap(gsub("_"," ", pathway), width = 40)
    ) %>%
    dplyr::group_by(Direction) %>%
    dplyr::slice_head(n = top_n) %>%
    dplyr::ungroup() %>%
    droplevels()

  # compress to one strip if only one side requested
  if (direction != "both") {
    lvl <- if (direction == "up") "Upregulated" else "Downregulated"
    to_plot$Direction <- factor(lvl, levels = lvl)
  }

  p <- ggplot(to_plot, aes(x = -log10(padj),
                           y = reorder(pathway, -padj),
                           size = size,
                           colour = abs(NES))) +
    geom_point(alpha = 0.5) +
    geom_vline(xintercept = -log10(0.05), linetype = "dashed",
               colour = "darkorange", linewidth = 0.8) +
    facet_grid(rows = vars(Direction), space = "free", scales = "free", drop = TRUE) +
    theme_ms() +
    labs(x = "-log10 FDR", y = "Pathway",
         title = stringr::str_to_title(tissue_name),
         colour = "|NES|", size = "Gene set size")

  list(result = gsea_res, plot = p)
}
```


## Generate the table with padj <1e-5

```{r}
make_and_save_tables <- function(gsea_res, tissue_name,
                                 padj_thresh = 0.05,
                                 out_dir = "data/gsea") {

  if (is.null(gsea_res) || !"pathway" %in% names(gsea_res) || nrow(gsea_res) == 0) {
    keep_df <- tibble::tibble(
      pathway_id = character(),
      pathway    = character(),
      Direction  = factor(levels = c("Upregulated","Downregulated")),
      NES        = numeric(),
      pval       = numeric(),
      padj       = numeric()
    )
    outfile <- file.path(out_dir, sprintf("GSEA_%s.csv", tissue_name, padj_thresh))
    readr::write_csv(keep_df, outfile)
    message(sprintf("[GSEA] %s: no pathways to save; wrote header-only file.", tissue_name))
    return(list(table = keep_df, file = outfile))
  }
    if (!"pathway_id" %in% names(gsea_res)) {
    gsea_res <- gsea_res %>%
      dplyr::left_join(pathway_map, by = c("pathway" = "pathway_desc"))
  }

  keep_df <- gsea_res %>%
    dplyr::filter(is.finite(padj), padj < padj_thresh) %>%
    dplyr::mutate(pathway = gsub("_", " ", pathway)) %>%
    dplyr::select(pathway_id, pathway, Direction, NES, pval, padj) 

    if (nrow(keep_df) == 0) {
      keep_df <- tibble::tibble(
        pathway_id = character(),
        pathway    = character(),
        Direction  = factor(levels = c("Upregulated","Downregulated")),
        NES        = numeric(),
        pval       = numeric(),
        padj       = numeric()
      )
    }
  
  outfile <- file.path(out_dir, sprintf("GSEA_%s.csv", tissue_name, padj_thresh))
  readr::write_csv(keep_df, outfile)
  list(table = keep_df, file = outfile)
}

```

## Run across tissues
```{r}
all_tables <- list()

gsea_plots <- lapply(tissues, function(t) {
  tissue_name <- gsub(" ","_",t)
  pval_table <- read.csv(here::here(result_dir, sprintf("%s_pvalue_results.csv", tissue_name)), header = TRUE,   na.strings = c("", "NA", "--", "Inf")
)
  res <- doGSEA(
    pval_table   = pval_table,
    gene_list    = gene_list,
    tissue_name  = tissue_name,
    direction    = direction_choice,   # "both"
    restrict_ranking = FALSE,
    top_n        = top_n
  )
  tbls <- make_and_save_tables(
    gsea_res     = res$result,
    tissue_name  = tissue_name,
    padj_thresh  = padj_thresh,
    out_dir      = out_dir
  )
  # all_tables[[tissue_name]] <- tbls$table %>%
  #   dplyr::mutate(tissue = tissue_name, .before = 1)

  ggsave(here::here(plot_dir, sprintf("DAS_%s_GSEA.png", t)),
         plot = res$plot, scale = 1, width = 9, height = out_height, dpi = 400, bg = "white")

  res$plot
  })
# all_df <- dplyr::bind_rows(all_tables)
# readr::write_csv(all_df, file.path(out_dir, "GSEA_all_tissues_padj1e-5.csv"))
# message(sprintf("[GSEA] Saved combined table: %s (n=%d)",
                # file.path(out_dir, "GSEA_all_tissues_padj1e-5.csv"), nrow(all_df)))

```

